// @ts-nocheck
import fetch from"node-fetch";import{createClient}from"@supabase/supabase-js";const supabase=createClient(process.env.SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY);export default async function handler(e,t){const s=e.query.uid,{data:a}=await supabase.from("oauth_tokens").select("*").eq("user_id",s).eq("provider","dexcom").single();if(!a)return t.status(404).json({error:"No Dexcom token"});const n=process.env.DEXCOM_BASE||"https://sandbox-api.dexcom.com",o=new Date,r=new Date(o.getTime()-216e5),i=new URLSearchParams({startDate:r.toISOString(),endDate:o.toISOString()}),c=await fetch(`${n}/v3/users/self/egvs?${i}`,{headers:{Authorization:`Bearer ${a.access_token}`}}),u=await c.json(),d=(u?.egvs||[]).map((e=>({user_id:s,device_time:e.displayTime||e.systemTime,reading_type:null,note:null,source:"dexcom",value_mgdl:e.value,trend:e.trend,timezone_offset_min:null})));d.length&&await supabase.from("glucose_readings").insert(d),t.status(200).json({inserted:d.length})}