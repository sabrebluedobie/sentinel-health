// @ts-nocheck
import crypto from"crypto";import{createClient}from"@supabase/supabase-js";const SUPABASE_URL=process.env.SUPABASE_URL||process.env.VITE_SUPABASE_URL,SERVICE_ROLE=process.env.SUPABASE_SERVICE_ROLE_KEY,sadmin=SUPABASE_URL&&SERVICE_ROLE?createClient(SUPABASE_URL,SERVICE_ROLE):null;async function readBody(e){return"GET"===e.method||"HEAD"===e.method?{}:await new Promise(((t,r)=>{let n="";e.on("data",(e=>n+=e)),e.on("end",(()=>{try{t(JSON.parse(n||"{}"))}catch(e){r(e)}})),e.on("error",r)}))}function nsHeaders(e,t){return e?{}:t?{"api-secret":crypto.createHash("sha1").update(String(t)).digest("hex")}:{}}export default async function handler(e,t){if("POST"===e.method)if(sadmin)try{const{url:r,token:n,api_secret:s,count:o=200,user_id:a}=await readBody(e);let i=r?.trim(),c=n||null,l=s||null;if(!i){if(!a)throw new Error("Missing url and user_id");const{data:e,error:t}=await sadmin.from("nightscout_connections").select("url, token, api_secret").eq("user_id",a).maybeSingle();if(t)throw t;if(!e?.url)throw new Error("No saved Nightscout connection");i=e.url,c=e.token||null,l=e.api_secret||null}i=i.replace(/\/+$/,"");const u=new URLSearchParams({count:String(o)});c&&u.set("token",c);const d=`${i}/api/v1/entries.json?${u.toString()}`,S=await fetch(d,{headers:nsHeaders(c,l)});if(!S.ok){const e=await S.text().catch((()=>""));throw new Error(`Nightscout error ${S.status}: ${e||S.statusText}`)}const _=await S.json(),g=(_||[]).map((e=>({user_id:a||null,device_time:e.dateString||(e.date?new Date(e.date).toISOString():null),value_mgdl:e.sgv??e.mgdl??null,trend:e.direction??null,source:"nightscout",note:null,created_at:(new Date).toISOString()}))).filter((e=>e.device_time&&null!=e.value_mgdl)),{data:h,error:E}=await sadmin.from("glucose_readings").insert(g);if(E)throw E;t.status(200).json({ok:!0,inserted:h?.length||0,skipped:(_?.length||0)-(h?.length||0)})}catch(e){t.status(400).json({ok:!1,error:e.message||String(e)})}else t.status(500).json({ok:!1,error:"supabase not configured"});else t.status(405).json({ok:!1,error:"POST only"})}