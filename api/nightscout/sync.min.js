// @ts-nocheck
import{createClient}from"@supabase/supabase-js";import fetch from"node-fetch";const SUPABASE_URL=process.env.SUPABASE_URL||process.env.VITE_SUPABASE_URL||process.env.NEXT_PUBLIC_SUPABASE_URL,SERVICE_ROLE=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.SUPABASE_SERVICE_ROLE||process.env.SUPABASE_SERVICE_KEY,serverSupabase=SUPABASE_URL&&SERVICE_ROLE?createClient(SUPABASE_URL,SERVICE_ROLE):null;function send(e,t,r,n={}){for(const[t,r]of Object.entries(n))e.setHeader(t,r);e.status(t).send("string"==typeof r?r:JSON.stringify(r))}async function readBody(e){return"GET"===e.method||"HEAD"===e.method?null:e.body&&"object"==typeof e.body?e.body:new Promise(((t,r)=>{let n="";e.on("data",(e=>n+=e)),e.on("end",(()=>{if(!n)return t({});try{t(JSON.parse(n))}catch{t({raw:n})}})),e.on("error",r)}))}async function getUserIdFromAuthHeader(e){const t=(e.headers.authorization||"").match(/^Bearer\s+(.+)$/i);if(!t)return null;const r=t[1],{data:n,error:s}=await serverSupabase.auth.getUser(r);return s?null:n?.user?.id??null}async function nightscoutSync(e,t){if(!serverSupabase)return send(t,500,{ok:!1,error:"Supabase not configured"});const r=await readBody(e),n=Math.max(1,Math.min(90,Number(r?.sinceDays??14))),s=await getUserIdFromAuthHeader(e)||r?.user_id||null;if(!s)return send(t,401,{ok:!1,error:"Not authenticated"});const{data:o,error:a}=await serverSupabase.from("nightscout_connections").select("url, token, api_secret").eq("user_id",s).maybeSingle();if(a)return send(t,500,{ok:!1,error:a.message});if(!o?.url)return send(t,400,{ok:!1,error:"No Nightscout URL saved"});const i=o.url.replace(/\/+$/,""),c=new Date(Date.now()-864e5*n).toISOString(),u=new URLSearchParams({count:"1200","find[dateString][$gte]":c});o.token&&u.set("token",o.token);const d=`${i}/api/v1/entries/sgv.json?${u.toString()}`,S=await fetch(d,{headers:o.api_secret?{"API-SECRET":o.api_secret}:void 0});if(!S.ok){const e=await S.text();return send(t,502,{ok:!1,error:`Nightscout error ${S.status}: ${e.slice(0,400)}`})}const l=(await S.json()||[]).map((e=>{const t=e.dateString?new Date(e.dateString).toISOString():e.date?new Date(e.date).toISOString():null,r=Number(e.sgv);return t&&isFinite(r)?{user_id:s,device_time:t,value_mgdl:r,trend:e.direction??null,source:"nightscout",created_at:(new Date).toISOString()}:null})).filter(Boolean);if(!l.length)return send(t,200,{ok:!0,inserted:0});let E=0;for(let e=0;e<l.length;e+=500){const r=l.slice(e,e+500),{error:n}=await serverSupabase.from("glucose_readings").insert(r);if(n)return send(t,500,{ok:!1,error:n.message,inserted:E});E+=r.length}return send(t,200,{ok:!0,inserted:E})}