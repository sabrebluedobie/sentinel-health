// @ts-nocheck
import crypto from"crypto";import{createClient}from"@supabase/supabase-js";const supabase=createClient(process.env.SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY);function normalizeBaseUrl(t){if(!t)return null;let e=t.trim();return/^https?:\/\//i.test(e)||(e="https://"+e),e=e.replace(/\/+$/,""),e}export default async function handler(t,e){try{const{uid:s,url:r,token:a=""}=t.query||{};if(!s)return e.status(400).json({error:"Missing uid"});if(!r)return e.status(400).json({error:"Missing url"});const n=normalizeBaseUrl(r),i=`${n}/api/v1/entries.json?count=100`,o=`${n}/api/v1/status.json`,u={Accept:"application/json"};if(a){const t=crypto.createHash("sha1").update(a).digest("hex");u["api-secret"]=t}const l=await fetch(o,{headers:u});if(!l.ok){const t=await l.text();return e.status(502).json({error:"Nightscout status failed",status:l.status,details:t?.slice(0,500)||"No details"})}const c=await fetch(i,{headers:u}),d=await c.text();if(!c.ok)return e.status(502).json({error:"Nightscout entries failed",status:c.status,details:d?.slice(0,800)||"No details"});let p;try{p=JSON.parse(d)}catch{return e.status(502).json({error:"Invalid JSON from Nightscout",sample:d?.slice(0,200)})}const f=(p||[]).map((t=>({user_id:s,device_time:t.dateString||t.date,reading_type:null,note:null,created_at:(new Date).toISOString(),source:"nightscout",value_mgdl:t.sgv??null,trend:t.direction??null,timezone_offset_min:null}))).filter((t=>null!=t.value_mgdl&&t.device_time));if(!f.length)return e.status(200).json({inserted:0,message:"No rows to insert."});const{error:g}=await supabase.from("glucose_readings").upsert(f,{onConflict:"user_id,device_time,source"});return g?e.status(500).json({error:"Supabase insert failed",details:g.message||g}):e.status(200).json({inserted:f.length})}catch(t){return e.status(500).json({error:String(t?.message||t)})}}